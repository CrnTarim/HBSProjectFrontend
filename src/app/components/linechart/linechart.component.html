<div class="wrap">
  <h1>Rapor İstatistikleri</h1>

  <!-- 1) Tarih -->
  <div class="card section">
    <div class="section-headline">
      <div class="badge">1</div><h3>Tarih</h3>
    </div>

    <div class="row dates">
      <div>
        <label>Başlangıç</label>
        <input type="date" [(ngModel)]="startDateStr">
      </div>
      <div>
        <label>Bitiş</label>
        <input type="date" [(ngModel)]="endDateStr">
      </div>

      <div class="right">
        <button (click)="onFetch()">Hesapla</button>
        <div class="hint inline">Aktif rapor (distinct): <b>{{ activeReportCount }}</b></div>
      </div>
    </div>
  </div>

  <!-- 2) Eksen & Kriter -->
  <div class="card section">
    <div class="section-headline">
      <div class="badge">2</div><h3>Eksen ve Kriter</h3>
    </div>

    <!-- Bölge pilleri -->
    <div class="block">
      <div class="label">Bölge</div>
      <div class="pills">
        <button [class.on]="rowSelected.Issuer"   (click)="toggleRow('Issuer')">Onaylayan</button>
        <button [class.on]="rowSelected.Force"    (click)="toggleRow('Force')">Kuvvet</button>
        <button [class.on]="rowSelected.Rank"     (click)="toggleRow('Rank')">Rütbe</button>
        <button [class.on]="rowSelected.City"     (click)="toggleRow('City')">Şehir</button>
        <button [class.on]="rowSelected.Hospital" (click)="toggleRow('Hospital')">Hastane</button>
      </div>
    </div>

    <!-- Bölge filtreleri -->
    <div class="block">
      <div class="inline-grid3">

        <!-- Şehir -->
        <div>
          <div class="section-toggle" (click)="openOnlyRegion('City')">
            <span>Şehir filtresi</span>
            <span class="chev" [class.open]="openCity">▾</span>
          </div>
          <div class="collapsible" [class.open]="openCity">
            <input type="text" placeholder="Şehir ara..." [(ngModel)]="citySearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let c of citiesFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedCityIds, c.id)" (change)="toggleCity(c.id)">
                  <span class="text">{{ c.name }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Hastane -->
        <div>
          <div class="section-toggle" (click)="openOnlyRegion('Hospital')">
            <span>Hastane filtresi</span>
            <span class="chev" [class.open]="openHospital">▾</span>
          </div>
          <div class="collapsible" [class.open]="openHospital">
            <input type="text" placeholder="Hastane ara..." [(ngModel)]="hospitalSearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let h of hospitalsForUIFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedHospitalIds, h.id)" (change)="toggleHospital(h.id)">
                  <span class="text">{{ h.name }}</span>
                </label>
              </div>
            </div>
            <div class="hint">İpucu: Şehir seçmek listeyi daraltır.</div>
          </div>
        </div>

        <!-- Kuvvet -->
        <div>
          <div class="section-toggle" (click)="openOnlyRegion('Force')">
            <span>Kuvvet filtresi</span>
            <span class="chev" [class.open]="openForce">▾</span>
          </div>
          <div class="collapsible" [class.open]="openForce">
            <input type="text" placeholder="Kuvvet ara..." [(ngModel)]="forceSearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let f of forcesForUIFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedForceIds, f.id)" (change)="toggleForce(f.id)">
                  <span class="text">{{ f.name }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Rütbe (ad ile) -->
        <div>
          <div class="section-toggle" (click)="openOnlyRegion('Rank')">
            <span>Rütbe filtresi</span>
            <span class="chev" [class.open]="openRank">▾</span>
          </div>
          <div class="collapsible" [class.open]="openRank">
            <input type="text" placeholder="Rütbe ara..." [(ngModel)]="rankSearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let h of ranksForUIFiltered()">
                  <input type="checkbox"
                         [checked]="isSelected(selectedRankNames, h.name)"
                         (change)="toggleRank(h.name)">
                  <span class="text">{{ h.name }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Onaylayan -->
        <div>
          <div class="section-toggle" (click)="openOnlyRegion('Issuer')">
            <span>Onaylayan filtresi</span>
            <span class="chev" [class.open]="openIssuer">▾</span>
          </div>
          <div class="collapsible" [class.open]="openIssuer">
            <div class="multi">
              <div class="options">
                <label *ngFor="let i of issuers">
                  <input type="checkbox" [checked]="isSelected(selectedIssuers, i)" (change)="toggleIssuer(i)">
                  <span class="text">{{ i }}</span>
                </label>
              </div>
            </div>
            <div class="hint">Satırda görmek için yukarıdan “Onaylayan”ı aç.</div>
          </div>
        </div>

      </div>
    </div>

    <div class="block">
      <div class="label">Kriter</div>
      <div class="pills">
        <button class="with-rank" [class.on]="columnRank('Diagnosis')" (click)="toggleColumn('Diagnosis')">
          Tanı <span *ngIf="columnRank('Diagnosis')" class="rank">{{ columnRank('Diagnosis') }}</span>
        </button>
        <button class="with-rank" [class.on]="columnRank('ReportState')" (click)="toggleColumn('ReportState')">
          Rapor Durumu <span *ngIf="columnRank('ReportState')" class="rank">{{ columnRank('ReportState') }}</span>
        </button>
        <button class="with-rank" [class.on]="columnRank('Decision')" (click)="toggleColumn('Decision')">
          Karar <span *ngIf="columnRank('Decision')" class="rank">{{ columnRank('Decision') }}</span>
        </button>
      </div>
    </div>

    <!-- Kriter filtreleri -->
    <div class="block">
      <div class="inline-grid3">
        <!-- Tanı -->
        <div>
          <div class="section-toggle" (click)="openOnlyCriteria('Diagnosis')">
            <span>Tanı filtresi</span>
            <span class="chev" [class.open]="openDiagnosis">▾</span>
          </div>
          <div class="collapsible" [class.open]="openDiagnosis">
            <input type="text" placeholder="Tanı ara..." [(ngModel)]="diagnosisSearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let d of diagnosesFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedDiagnosisIds, d.id)" (change)="toggleDiagnosis(d.id)">
                  <span class="text">{{ d.code }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Durum -->
        <div>
          <div class="section-toggle" (click)="openOnlyCriteria('ReportState')">
            <span>Durum filtresi</span>
            <span class="chev" [class.open]="openState">▾</span>
          </div>
          <div class="collapsible" [class.open]="openState">
            <input type="text" placeholder="Durum ara..." [(ngModel)]="stateSearch" class="searchbox">
            <div class="multi">
              <div class="options">
                <label *ngFor="let s of statesFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedStates, s)" (change)="toggleState(s)">
                  <span class="text">{{ trState(s) }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Karar -->
        <div>
          <div class="section-toggle" (click)="openOnlyCriteria('Decision')">
            <span>Karar filtresi</span>
            <span class="chev" [class.open]="openDecision">▾</span>
          </div>
          <div class="collapsible" [class.open]="openDecision">
            <input type="text" placeholder="Karar ara (ad/kod)..." [(ngModel)]="decisionSearch" class="searchbox">
            <div class="multi decisions">
              <div class="options">
                <label *ngFor="let k of decisionsFiltered()">
                  <input type="checkbox" [checked]="isSelected(selectedDecisionIds, k.id)" (change)="toggleDecision(k.id)">
                  <span class="text">{{ k.name }} ({{k.code}})</span>
                </label>
              </div>
            </div>
            <div class="hint">İpucu: Onaylayan filtresi üstte.</div>
          </div>
        </div>
      </div>
    </div>


    <!-- Yüzde ekseni -->
    <div class="block">
      <div class="label">Yüzde Ekseni</div>
      <div class="pills">
        <button [class.on]="percentBasis==='row'"    (click)="percentBasis='row';    updatePivot()">% Satır</button>
        <button [class.on]="percentBasis==='column'" (click)="percentBasis='column'; updatePivot()">% Sütun</button>
        <button [class.on]="percentBasis==='grand'"  (click)="percentBasis='grand';  updatePivot()">% Genel</button>
      </div>
    </div>

    <!-- Ölçüler -->
    <div class="block">
      <div class="label">Ölçüler</div>
      <label>
        <input type="checkbox"
               [(ngModel)]="showCount"
               (change)="toggleMeasure('cntRows', showCount)">
        <span>Rapor (sayısı)</span>
      </label>
      <label style="margin-left:16px;">
        <input type="checkbox"
               [(ngModel)]="showDistinct"
               (change)="toggleMeasure('cntDistinctReports', showDistinct)">
        <span>Rapor (distinct)</span>
      </label>
    </div>
  </div>

  <!-- 3) Pivot -->
  <div class="card section">
    <div class="section-headline" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="badge">3</div><h3>Sonuçlar</h3>
      </div>
    </div>

    <div *ngIf="!factActive.length" class="hint">Tarih seçip <b>Hesapla</b>’ya basın.</div>

    <div class="pivot" *ngIf="factActive.length">
      <dx-pivot-grid
        [dataSource]="pivotDs"
        [allowSortingBySummary]="true"
        [allowFiltering]="true"
        [showBorders]="true"
        [showColumnTotals]="true"
        [showRowTotals]="true"
        [showColumnGrandTotals]="true"
        [showRowGrandTotals]="true"
        [fieldPanel]="{
          visible: true,
          showFilterFields: true,
          showRowFields: true,
          showColumnFields: true,
          showDataFields: true
        }">
      </dx-pivot-grid>
    </div>
  </div>
</div>
